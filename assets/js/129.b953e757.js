(window.webpackJsonp=window.webpackJsonp||[]).push([[129],{453:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"线程同步与进程通信"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#线程同步与进程通信"}},[t._v("#")]),t._v(" 线程同步与进程通信")]),t._v(" "),s("h3",{attrs:{id:"线程同步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#线程同步"}},[t._v("#")]),t._v(" 线程同步")]),t._v(" "),s("p",[s("strong",[t._v("互斥量")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("临界资源：在一段时间内只允许一个任务（线程或进程）访问资源。任务之间采用互斥的方式访问临界资源")])]),t._v(" "),s("li",[s("p",[t._v("互斥量："),s("code",[t._v("pthread_mutex_t mutex;")]),t._v(" 初始化、加锁、解锁、销毁")]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("加锁："),s("code",[t._v("int pthread_mutex_lock(); int pthread_mutex_trylock();")]),t._v("在访问临界资源前，对互斥量进行加锁。"),s("code",[t._v("trylock()")]),t._v("未加锁则加锁，加锁后不重复加锁。")]),t._v(" "),s("li",[t._v("解锁："),s("code",[t._v("int pthread_mutex_unlock();")]),t._v("访问完成后对互斥量解锁")]),t._v(" "),s("li",[t._v("销毁："),s("code",[t._v("int pthread_mutex_destory();")]),t._v("互斥量使用完毕后对互斥量进行销毁，释放资源。")])])])])]),t._v(" "),s("p",[s("strong",[t._v("条件变量")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("任务同步：多个线程都要访问临界资源又要相互合作，一个任务的执行依赖与另一个任务的执行情况。")])]),t._v(" "),s("li",[s("p",[t._v("条件变量："),s("code",[t._v("pthread_cond_t cond;")]),t._v("和互斥量一起使用，允许线程以互斥的方式阻塞等待条件的发生即为同步关系")]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("触发条件变量的线程：互斥量加锁>>某一操作>>触发条件变量>>互斥量解锁")]),t._v(" "),s("li",[t._v("等待条件变量的线程：互斥量加锁>>等待条件变量>>某一操作>>互斥量解锁")]),t._v(" "),s("li",[t._v("销毁："),s("code",[t._v("pthread_cond_destory();")]),t._v("条件变量不再使用后进行销毁，释放空间")]),t._v(" "),s("li",[t._v("等待条件变量："),s("code",[t._v("pthread_cond_wait();")]),t._v("使得调用进程进入阻塞状态，直到条件触发")]),t._v(" "),s("li",[t._v("触发条件变量："),s("code",[t._v("pthread_cond_signal();/pthread_cond_broadcast();")]),t._v("可触发并唤醒等待条件变量的线程")])])])]),t._v(" "),s("li",[s("p",[t._v("条件变量与互斥量要配合使用")]),t._v(" "),s("blockquote",[s("ul",[s("li",[s("p",[t._v("条件变量的使用场景伴随着临界资源的使用")])]),t._v(" "),s("li",[s("p",[t._v("在调用"),s("code",[t._v("pthread_cond_wait();")]),t._v("前需要使互斥量处于加锁状态，通过原子操作将调用线程放到该条件变量等待线程队列（临界资源）中")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//等待条件变量的操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_cond_wait")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])])])]),t._v(" "),s("li",[s("p",[t._v("条件变量的使用"),s("code",[t._v("4.1.1.c")])])])]),t._v(" "),s("p",[s("strong",[t._v("读写锁")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("读写关系：读写互斥、写写互斥、读读不互斥")])]),t._v(" "),s("li",[s("p",[t._v("读写锁："),s("code",[t._v("pthread_rwlock_t;")])]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("加读锁："),s("code",[t._v("阻塞加锁pthread_rwlock_rdlock();/非阻塞加锁pthread_rwlock_tryrdlock();/限时加读锁pthread_rwlock_timedrdlock();")])]),t._v(" "),s("li",[t._v("加写锁："),s("code",[t._v("阻塞加锁pthread_rwlock_wrlock();/非阻塞加锁pthread_rwlock_trywrlock();/限时加读锁pthread_rwlock_timedwrlock();")])]),t._v(" "),s("li",[t._v("解锁：统一解锁函数，最近配对原则解锁"),s("code",[t._v("pthread_rwlock_unlock();")])])])])])]),t._v(" "),s("h3",{attrs:{id:"进程通信"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#进程通信"}},[t._v("#")]),t._v(" 进程通信")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("管道和命名管道：文件的形式实现不同进程共享资源")])]),t._v(" "),s("li",[s("p",[t._v("XSI IPC机制：LINUX系统使用的进程通信机制")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("功能")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("信号量")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("共享内存")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("消息队列")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("创建或打开一个IPC对象，获得对IPC机制的访问权")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("semget")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("shmget")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("msgget")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("IPC操作：信号量操作；连接/释放共享内存；发送/接收消息")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("semop")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("shmat/shmdt")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("msgsnd/msgrcv")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("IPC控制：获得/修改IPC对象状态，“删除”IPC对象")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("semctl")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("shmctl")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("msgctl")])])])])])]),t._v(" "),s("p",[s("strong",[t._v("消息队列")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("消息队列：消息的链表，有写或者读权限的进程可以按照一定的规则添加或者读取消息")])]),t._v(" "),s("li",[s("p",[t._v("消息队列的操作"),s("code",[t._v("sys/types.h sys/ipc.h sys/msg.h")]),t._v(" "),s("code",[t._v("4.2.1")])]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("打开或创建消息队列对象："),s("code",[t._v("int msgget();")])]),t._v(" "),s("li",[t._v("从消息队列接收消息："),s("code",[t._v("int msgrcv();")])]),t._v(" "),s("li",[t._v("向消息队列发送消息："),s("code",[t._v("int msgsnd();")])]),t._v(" "),s("li",[t._v("消息队列控制操作："),s("code",[t._v("int msgctl();")])])])])])]),t._v(" "),s("p",[s("strong",[t._v("信号量")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("互斥信号量：任务之间互斥访问临界资源  初始值为1")])]),t._v(" "),s("li",[s("p",[t._v("计数信号量：任务之间竞争访问共享资源 初始值大于1，表示共享资源个数")])]),t._v(" "),s("li",[s("p",[t._v("二值信号量：任务之间的同步机制 初始值为0")])]),t._v(" "),s("li",[s("p",[t._v("信号量的数据结构")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("s")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//资源计数")]),t._v("\n    Queue queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//任务阻塞队列")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("P")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// P操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("V")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// V操作")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("P操作：分配资源")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t调用进程进入s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t阻塞调用进程；\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("V操作：释放资源")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t从阻塞队列s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queue中取出一个进程P"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t进程P进入就绪队列"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("信号量集的操作"),s("code",[t._v("sys/types.h sys/ipc.h sys/sem.h")])]),t._v(" "),s("blockquote",[s("ul",[s("li",[s("p",[t._v("创建或者打开信号量集对象"),s("code",[t._v("int semget();")])]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdio.h>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<sys/sem.h>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token macro property"}},[s("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MYKEY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token expression"}},[s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x1a0a")]),t._v(" ")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//定一个ipc的key值")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" semid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsemid "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semget")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MYKEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("IPC_CREAT"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("IPC_R"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("IPC_W"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("IPC_M"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建一个信号量集对象")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"semid = %d\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("semid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("信号量PV操作"),s("code",[t._v("int semop();")]),t._v("：根据参数"),s("code",[t._v("short sem_op;")]),t._v("判断执行的操作类型")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("sem_op > 0")]),t._v("：信号量V操作，增加信号量的值")]),t._v(" "),s("li",[s("code",[t._v("sem_op < 0")]),t._v("：信号量P操作，减少信号量的值")]),t._v(" "),s("li",[s("code",[t._v("sem_op = 0")]),t._v("：对信号量的当前值是否为0的测试")])]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//实现P操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semaphore_v")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sembuf")]),t._v(" sem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sem_num "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//信号量编号")]),t._v("\n\tsem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sem_op "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// P操作")]),t._v("\n\tsem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sem_fg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SEM_UNDO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//在进程没释放信号量而退出时，系统自动释放该进程中未释放的信号量")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sem_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("sem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fprintf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stderr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"semaphore_p failed\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//实现V操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semaphore_v")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sembuf")]),t._v(" sem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sem_num "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sem_op "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// V操作")]),t._v("\n\tsem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sem_fg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SEM_UNDO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sem_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("sem_b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fprintf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stderr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"semaphore_v failed\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("信号量控制"),s("code",[t._v("int semctl();")]),t._v(" ："),s("code",[t._v("int cmd;")]),t._v("控制命令参数")]),t._v(" "),s("ul",[s("li",[t._v("对信号量集的控制命令："),s("code",[t._v("IPC_RMID")]),t._v("删除；"),s("code",[t._v("IPC_SET")]),t._v("设置参数；"),s("code",[t._v("IPC_STAT")]),t._v("获取参数；"),s("code",[t._v("IPC_INFO")]),t._v("获取系统信息")]),t._v(" "),s("li",[t._v("对信号量的控制命令："),s("code",[t._v("SETVAL")]),t._v("设置信号量的值；"),s("code",[t._v("GETVAL")]),t._v("获取信号量的值；"),s("code",[t._v("GETPID")]),t._v("获取信号量拥有者的PID值")])]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//信号量初始化")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_sem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" sem_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" init_value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" semun_sem_union"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsem_union"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("val "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" init_value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semctl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sem_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("SETVAL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sem_union"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("perror")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Initialize semaphore"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//从系统中删除信号量")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("del_sem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" sem_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" semun sem_union"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("semctl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sem_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("IPC_RMID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("sem_union"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("perror")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Initialize semaphore"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])])])])]),t._v(" "),s("p",[s("strong",[t._v("共享内存")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("共享内存：不同进程可以将同一段内存空间链接到自己的地址空间中，类似物理空间中的全局变量")])]),t._v(" "),s("li",[s("p",[t._v("共享内存的操作"),s("code",[t._v("sys/types.h sys/ipc.h sys/shm.h")])]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("创建或者打开共享内存对象"),s("code",[t._v("int shmget();")])]),t._v(" "),s("li",[t._v("将共享内存链接到调用的进程的地址空间"),s("code",[t._v("void *shmat();")])]),t._v(" "),s("li",[t._v("删除进程的共享内存链接"),s("code",[t._v("int shmdt();")])]),t._v(" "),s("li",[t._v("对共享内存的操作"),s("code",[t._v("int shmctl();")])])])])]),t._v(" "),s("li",[s("p",[t._v("共享内存应用--生产者/消费者问题"),s("code",[t._v("4.2.2.c")])]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//缓存池结构")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BufferPool")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" Buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);